# 配置文件可运行
# 策略文件(Gemini之前的)可运行

#############################################
# 订阅定义 *无须关注* 
#############################################

proxy-providers:
  SSRDOG:
    url: "https://83c30bfd.jpg" # <--- 请在此填入机场A的订阅链接
    type: http
    interval: 86400
    health-check: {enable: true, url: "https://cp.cloudflare.com/generate_204", interval: 300, timeout: 4000}
    override:
      additional-prefix: "[SSRDOG]"

  CroLAX:
    url: "https://2s4" # <--- 请在此填入机场B的订阅链接
    type: http
    interval: 86400
    health-check: {enable: true, url: "https://cp.cloudflare.com/generate_204", interval: 300, timeout: 4000}
    override:
      additional-prefix: "[CroLAX]"
proxies:
  - {name: "直连", type: direct, udp: true}
  - {name: "拒绝", type: reject}

#############################################
# 基础参数 *无须关注*
#############################################
# 主要端口
mixed-port: 10801
port: 7890
socks-port: 7891
redir-port: 7892
tproxy-port: 7893

allow-lan: true
mode: rule
log-level: warning
ipv6: false
unified-delay: true # 统一延迟
tcp-concurrent: true
bind-address: '*'
find-process-mode: off # strict
global-client-fingerprint: chrome
profile:
  store-selected: true
  tracing: false
  store-fake-ip: true

# Zashboard 网页管理
external-controller: '[::]:9090'
external-ui: ui
external-ui-name: Zashboard
external-ui-url: https://gh-proxy.com/https://github.com/Zephyruso/zashboard/releases/latest/download/dist-cdn-fonts.zip
secret: "181818"

# 硬件与控制选项 (保持原版配置)
interface-name: eth0
disable-keep-alive: false
keep-alive-idle: 600
keep-alive-interval: 30

# GeoIP 数据库 (用于 GeoIP 规则) qWen 提供的
hosts:
  localhost.localhost: 127.0.0.1
geodata-mode: false
geodata-loader: standard
geox-url:
  geoip: "https://gh-proxy.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat"
  geosite: "https://gh-proxy.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
  mmdb: "https://gh-proxy.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb"
  asn: "https://gh-proxy.com/https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb"
geo-auto-update: true
geo-update-interval: 72

#############################################
# 嗅探 *无须关注*
#############################################

sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  sniff:
    HTTP:
      port:
        - "80"
        - "8080"
      override-destination: true
    TLS:
      port:
        - "443"
        - "8443"
      override-destination: true
    QUIC:
      port:
        - "443"
        - "8443"
      override-destination: true

  # 强制解析域名 # Gemini加的，我没看懂
  # force-domain: 
  #   - "+.google.com"
  skip-domain: # 跳过域名
    - '223.5.5.5'
    - 'courier.push.apple.com'
    - "+.push.apple.com"

#############################################
# 入站 
#############################################

tun:
  enable: true
  # 使用 Nikki 混入全部不修改的情况，开启接口指定为nikki
  device: nikki # utun # openclash 用 gvisor
  stack: system # gvisor # 不玩游戏用 system 更稳妥，openclash 用 gvisor
  mtu: 1500 #
  gso: true #
  gso-max-size: 65536 #
  # endpoint-independent-nat: true # 启用独立于端点的 NAT # 安格视界设置开启
  # auto-route: false # 配置路由表 # 安格视界设置关闭
  # 使用仅内核改下面三项为 true # Gemini 建议开启下面三项
  auto-route: false
  auto-redirect: false
  auto-detect-interface: false
  # 劫持DNS请求
  # dns-hijack: 
  #   - "any:53"
  #   - "tcp://any:53"

#############################################
# DNS
#############################################

dns:
  enable: true
  ipv6: false
  listen: '0.0.0.0:1053'
  enhanced-mode: fake-ip
  fake-ip-range: 28.0.0.1/8  # 借鉴防泄版：使用非常规网段，减少与公共 Fake-IP 网段冲突
  use-hosts: true # 查询 hosts
  cache-algorithm: arc
  respect-rules: true
  prefer-h3: false
  # 1. 精简并加固 Fake-IP 过滤 (移除重复项，增加本地服务)
  fake-ip-filter:
    # - "*"  # 必须删除此行，否则 Fake-IP 无效
    - "+.lan"
    - "+.local"
    - "geosite:cn"  # 绕过国内
    - "+.2000w.xyz"  # 绕过机场
    - "+.beijing-aliyuncs.sbs"  # 绕过机场
    - "rule-set:fakeipfilter_domain"  # 国内需要返回真实IP的规则
    
  fake-ip-filter-mode: blacklist
  
  # # 2. 默认解析器：仅用于解析 DOH 国内域名仅，确保拨号和基础连接秒开
  default-nameserver:
    - 223.5.5.5
    # - 119.29.29.29  # 保留阿里足够了

  # 3. 代理服务器域名解析：解析你的订阅链接域名，确保侧旁路能快速找到机场入口
  proxy-server-nameserver:
    - 192.168.50.1  # 优先问 ROS
    - 223.5.5.5  # 确保能解析订阅站

  # 4. 国内直连解析器：专门负责 geosite:cn
  direct-nameserver:
    - 192.168.50.1  # 优先问 ROS
    # - 223.5.5.5

  # 5. 主解析器：处理未分类域名 (UDP 模式确保速度)
  nameserver:
    - 192.168.50.1  # 优先问 ROS
    # - 223.5.5.5  # 纯 IP (UDP 模式)  # 指向 Ros 
    # - https://223.5.5.5/dns-query  # 加密 DNS

  # 6. 兜底解析器(主DNS失效时兜底)：处理国外域名 (DoH 模式通过代理转发)
  fallback:
    # - https://8.8.8.8/dns-query#08_🌍-全球最速  # 强制 DNS 请求走代理，彻底防泄露
    # - https://1.1.1.1/dns-query#08_🌍-全球最速  # 对应你的策略组名
    - https://8.8.8.8/dns-query#08_🌍-全球最速&ecs=223.5.5.0/24 # # 吸收七尺宇精华：给 8.8.8.8 加上规则预审和 ECS 优化
    - https://1.1.1.1/dns-query#08_🌍-全球最速&ecs=223.5.5.0/24

  # 7. 核心：精准分流策略，必须结果 rules: 中放行规则使用
  nameserver-policy:
    # 启动加速组 (直连解析)
    "gh-proxy.com,mirror.ghproxy.com,ghproxy.net": [223.5.5.5]
    # 内网与国内组 (利用 ROS 缓存)
    "geosite:cn,private": [192.168.50.1, 223.5.5.5]
    "lan,local": [192.168.50.1]
    # 核心开发组 (加密解析)
    "geosite:github,category-dev,huggingface,docker": [https://8.8.8.8/dns-query]
    # AI 与 视频组 (加密解析)
    "geosite:google,youtube,openai,google-gemini,category-ai-!cn": [https://8.8.8.8/dns-query]

  # 8. 降级过滤：防止国内 DNS 抢跑返回污染 IP
  fallback-filter:
    geoip: true
    geoip-code: CN
    geosite: [gfw]
    ipcidr: [240.0.0.0/4]

#############################################
# 策略组模块 - 2026 终极版
#############################################

# 通用锚点定义
default: &default
  type: select
  proxies:
    - 🦺-香港-故转
    - 🦺-台湾-故转
    - 🦺-日本-故转
    - 🦺-新加坡-故转
    - 🦺-美国-故转
    - 亚洲-故转
    - 欧洲-故转
    - 08_🌍-全球最速
    - 09_👉-手动选择
    - 直连
    - 拒绝

proxy-groups:
  # -----------------------------------------
  # 一、业务分流组 (01-09)
  # -----------------------------------------
  
  # 01 AI组：优先显示美国和新加坡，确保 ChatGPT/Gemini 稳定性
  - name: 01_🧠-AI/大数据
    type: select
    proxies:
      - 🦺-美国-故转
      - 🦺-新加坡-故转

  - name: 02_📱-通讯/社交
    type: select
    proxies:
      - 🦺-新加坡-故转
      - 🦺-台湾-故转

  - name: 03_🏢-办公/厂商
    type: select
    proxies:
      - 🦺-台湾-故转
      - 🦺-香港-故转

  - name: 04_🎬-视频/娱乐
    type: select
    proxies:
      - 08_🌍-全球最速
      - 🦺-日本-故转
      - 🦺-新加坡-故转

  - name: 05_💻-开发/基础
    type: select
    proxies:
      - 🦺-香港-故转
      - 🦺-日本-故转

  - name: 06_🔞-NSFW
    type: select
    proxies:
      - 🦺-美国-故转
      - 🦺-台湾-故转

  - name: 07_🚀-国内直连
    type: select
    proxies:
      - DIRECT

  - name: 08_🌍-全球最速
    type: url-test
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
    tolerance: 50
    include-all: true
    filter: "^((?!(直连|拒绝)).)*$"

  - name: 09_👉-手动选择 
    type: select
    include-all: true
    filter: "^((?!(直连|拒绝)).)*$"

  # -----------------------------------------
  # 二、区域级高级组 (故转+手选+自动)
  # -----------------------------------------

  # --- 香港组 ---
  - name: "🦺-香港-故转"
    type: fallback
    proxies: ["👉-香港-手选", "⏩-香港-自动"]
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
  - name: "👉-香港-手选"
    type: select
    include-all: true
    filter: "(?i)香港|🇭🇰|Hong\\s*[-_]?\\s*Kong|\\bHK\\b"
  - name: "⏩-香港-自动"
    type: url-test
    include-all: true
    filter: "(?i)香港|🇭🇰|Hong\\s*[-_]?\\s*Kong|\\bHK\\b"
    tolerance: 50
    interval: 300

  # --- 台湾组 ---
  - name: "🦺-台湾-故转"
    type: fallback
    proxies: ["👉-台湾-手选", "⏩-台湾-自动"]
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
  - name: "👉-台湾-手选"
    type: select
    include-all: true
    filter: "(?i)台湾|台北|🇹🇼|Taiwan|\\bTW\\b"
  - name: "⏩-台湾-自动"
    type: url-test
    include-all: true
    filter: "(?i)台湾|台北|🇹🇼|Taiwan|\\bTW\\b"
    tolerance: 50
    interval: 300

  # --- 日本组 ---
  - name: "🦺-日本-故转"
    type: fallback
    proxies: ["👉-日本-手选", "⏩-日本-自动"]
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
  - name: "👉-日本-手选"
    type: select
    include-all: true
    filter: "(?i)日本|东京|🇯🇵|Japan|\\bJP\\b"
  - name: "⏩-日本-自动"
    type: url-test
    include-all: true
    filter: "(?i)日本|东京|🇯🇵|Japan|\\bJP\\b"
    tolerance: 50
    interval: 300

  # --- 新加坡组 ---
  - name: "🦺-新加坡-故转"
    type: fallback
    proxies: ["👉-新加坡-手选", "⏩-新加坡-自动"]
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
  - name: "👉-新加坡-手选"
    type: select
    include-all: true
    filter: "(?i)新加坡|狮城|🇸🇬|Singapore|\\bSG\\b"
  - name: "⏩-新加坡-自动"
    type: url-test
    include-all: true
    filter: "(?i)新加坡|狮城|🇸🇬|Singapore|\\bSG\\b"
    tolerance: 50
    interval: 300

  # --- 美国组 ---
  - name: "🦺-美国-故转"
    type: fallback
    proxies: ["👉-美国-手选", "⏩-美国-自动"]
    url: "https://cp.cloudflare.com/generate_204"
    interval: 300
  - name: "👉-美国-手选"
    type: select
    include-all: true
    filter: "(?i)美国|🇺🇸|United\\s*States|America|\\bUS\\b"
  - name: "⏩-美国-自动"
    type: url-test
    include-all: true
    filter: "(?i)美国|🇺🇸|United\\s*States|America|\\bUS\\b"
    tolerance: 50
    interval: 300

#############################################
# 规则源定义 (Rule Providers)
#############################################
rule-anchor:
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: mrs}
  domain: &domain {type: http, interval: 86400, behavior: domain, format: mrs}
  class: &class {type: http, interval: 86400, behavior: classical, format: text}

rule-providers:
  # 七尺宇配合fake-ip-filter自建的规则
  fakeipfilter_domain: {<<: *domain, url: "https://raw.githubusercontent.com/wwqgtxx/clash-rules/release/fakeip-filter.mrs"}

  # 01_🧠-AI/大数据
  ai-openai: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/openai.mrs"}
  ai-gemini: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/google-gemini.mrs"}
  ai-claude: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/anthropic.mrs"}
  ai-perplexity: {<<: *domain, url: "https://gh-proxy.com/github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/perplexity.mrs"}
  ai-creative: {<<: *domain, url: "https://gh-proxy.com/github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-ai-chat-!cn.mrs"}  
  ai-all: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-ai-!cn.mrs"}
  data-huggingface: {<<: *domain, url: "https://gh-proxy.com/github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/huggingface.mrs"}
  data-kaggle: {<<: *domain, url: "https://gh-proxy.com/github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/kaggle.mrs"}

  # 02_📱-通讯/社交
  social-telegram: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/telegram.mrs"}
  social-telegram-ip: {<<: *ip, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geoip/telegram.mrs"}
  social-twitter: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/x.mrs"}
  social-discord: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/discord.mrs"}
  social-meta: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/meta.mrs"}
  social-tiktok: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/tiktok.mrs"}

  # 03_🏢-办公/厂商
  office-google: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/google.mrs"}
  office-microsoft: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/microsoft.mrs"}
  office-apple: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/apple.mrs"}
  office-adobe: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/adobe.mrs"}

  # 04_🎬-视频/娱乐
  media-youtube: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/youtube.mrs"}
  media-netflix: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/netflix.mrs"}
  media-vimeo: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/vimeo.mrs"}
  media-tiktok: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/tiktok.mrs"}

  # 05_💻-开发/基础 (tScan 生产力核心)
  dev-github: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/github.mrs"}
  dev-docker: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/docker.mrs"}
  dev-python: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/python.mrs"}
  dev-core: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-dev.mrs"}

  # 06_🔞-NSFW
  nsfw-all: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-porn.mrs"}

  # 07_🚀-国内直连
  cn-all: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/cn.mrs"}



#############################################
# 分流规则逻辑 (Rules)
#############################################
rules:
  # [DNS 特权通道] 确保国内解析不被误伤
  - IP-CIDR,223.5.5.5/32,DIRECT,no-resolve

  # [启动加速] 确保规则下载镜像直连
  - DOMAIN-SUFFIX,gh-proxy.com,DIRECT
  - DOMAIN-SUFFIX,mirror.ghproxy.com,DIRECT
  - DOMAIN-SUFFIX,ghproxy.net,DIRECT

  # ============================================
  # Level 1: 高敏感 / 高风控 / 特例 (Must Top)
  # ============================================
  # [01 AI] Gemini 必须在 Google 办公之前匹配
  - RULE-SET,ai-openai,01_🧠-AI/大数据
  - RULE-SET,ai-gemini,01_🧠-AI/大数据
  - RULE-SET,ai-claude,01_🧠-AI/大数据
  - RULE-SET,ai-perplexity,01_🧠-AI/大数据
  
  # [01 AI] 创作与大数据工具
  - RULE-SET,ai-creative,01_🧠-AI/大数据
  - RULE-SET,data-huggingface,01_🧠-AI/大数据
  - RULE-SET,data-kaggle,01_🧠-AI/大数据
  - RULE-SET,ai-all,01_🧠-AI/大数据

  # [06 NSFW] 隐私隔离 (先于社交和办公匹配，防关联)
  - RULE-SET,nsfw-all,06_🔞-NSFW

  # ============================================
  # Level 2: 实时通讯 / 核心开发 (Low Latency)
  # ============================================
  # [02 社交] Telegram IP 规则需加 no-resolve
  - RULE-SET,social-telegram,02_📱-通讯/社交
  - RULE-SET,social-telegram-ip,02_📱-通讯/社交,no-resolve
  - RULE-SET,social-discord,02_📱-通讯/社交
  - RULE-SET,social-twitter,02_📱-通讯/社交
  - RULE-SET,social-meta,02_📱-通讯/社交

  # [05 开发] tScan 核心 (GitHub/Docker 优先于通用办公)
  - RULE-SET,dev-github,05_💻-开发/基础
  - RULE-SET,dev-docker,05_💻-开发/基础
  - RULE-SET,dev-python,05_💻-开发/基础
  - RULE-SET,dev-core,05_💻-开发/基础

  # ============================================
  # Level 3: 影音特例 / 厂商生态 (Productivity)
  # ============================================
  # [04 视频] 头部视频站 (Vimeo/YouTube 必须在 Google 办公之前)
  - RULE-SET,media-vimeo,04_🎬-视频/娱乐
  - RULE-SET,media-youtube,04_🎬-视频/娱乐
  - RULE-SET,media-netflix,04_🎬-视频/娱乐
  - RULE-SET,media-tiktok,04_🎬-视频/娱乐

  # [03 办公] 厂商大类 (兜底 Google/Microsoft 全家桶)
  - RULE-SET,office-adobe,03_🏢-办公/厂商
  - RULE-SET,office-microsoft,03_🏢-办公/厂商
  - RULE-SET,office-apple,03_🏢-办公/厂商
  - RULE-SET,office-google,03_🏢-办公/厂商

  # [07 直连] 国内流量与局域网
  - RULE-SET,cn-all,07_🚀-国内直连
  - GEOIP,CN,07_🚀-国内直连,no-resolve

  # [08 终点] 全球兜底

  - MATCH,08_🌍-全球最速
